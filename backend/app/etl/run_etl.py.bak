import os
#os.environ["YFINANCE_USE_CURL"] = "false"
os.environ.setdefault("SSL_CERT_FILE", "/usr/local/lib/python3.11/site-packages/certifi/cacert.pem")
os.environ.setdefault("REQUESTS_CA_BUNDLE", "/usr/local/lib/python3.11/site-packages/certifi/cacert.pem")

import sys, argparse, logging, traceback
from datetime import date
from app.etl.tickers_loader import load_tickers
from app.etl.fetch_data import fetch_prices
from app.etl.compute_signals import compute_all_signals
from app.etl.rebalance_indices import reconstitute_and_rebalance

log = logging.getLogger("etl")
logging.basicConfig(level=logging.INFO, format="%(asctime)s %(levelname)s %(message)s")
log.info("YFINANCE_USE_CURL=%s", os.getenv("YFINANCE_USE_CURL"))

def parse_args():
    p = argparse.ArgumentParser(description="Run ETL pipeline")
    p.add_argument("--tickers-file", default=os.getenv("TICKERS_FILE", "").strip(),
                   help="Path to tickers file (.txt/.csv/.yaml)")
    p.add_argument("--skip-prices", action="store_true")
    p.add_argument("--skip-signals", action="store_true")
    p.add_argument("--skip-rebalance", action="store_true")
    p.add_argument("--universe", default=None, help="match tickers.universe (text[])")
    p.add_argument("--limit", type=int, default=None)
    p.add_argument("--tickers-file", default=None)  # optional fallback
    p.add_argument("--db-url", default=os.getenv("DATABASE_URL", "postgresql+psycopg://postgres:postgres@db:5432/finance"))
    return p.parse_args()

def main():
    args = parse_args()
    ok = True
    tickers = []
   

    if args.tickers_file:
        try:
            tickers = load_tickers(args.tickers_file)
            log.info("Loaded %d tickers from %s", len(tickers), args.tickers_file)
        except Exception as e:
            log.error("Failed to load tickers: %s", e)
            ok = False

    if ok and not args.skip_prices:
        try:
            fetch_prices(tickers)
        except Exception as e:
            ok = False
            log.error("fetch_prices failed: %s", e)
            traceback.print_exc()

    if ok and not args.skip_signals:
        try:
            compute_all_signals()
        except Exception as e:
            ok = False
            log.error("compute_all_signals failed: %s", e)
            traceback.print_exc()

    if ok and not args.skip_rebalance:
        try:
            reconstitute_and_rebalance(asof=date.today())
        except Exception as e:
            ok = False
            log.error("reconstitute_and_rebalance failed: %s", e)
            traceback.print_exc()

    if not ok:
        log.error("ETL FAILED")
        sys.exit(1)
    log.info("âœ… ETL complete")

if __name__ == "__main__":
    main()

